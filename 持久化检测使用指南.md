# 🔒 持久化检测功能 - 使用指南

## 📋 功能概述

新增的持久化检测模块可以检测恶意软件常用的8种持久化机制：

1. ✅ **注册表Run键** - HKLM/HKCU\Software\Microsoft\Windows\CurrentVersion\Run
2. ✅ **计划任务** - Windows Task Scheduler
3. ✅ **Windows服务** - 系统服务创建
4. ✅ **启动文件夹** - Startup文件夹中的文件
5. ✅ **WMI事件订阅** - 高级持久化技术
6. ✅ **Winlogon劫持** - Shell/Userinit等关键启动项
7. ✅ **IFEO劫持** - 映像劫持(Image File Execution Options)
8. ✅ **浏览器扩展** - Chrome扩展安装

## 🚀 快速测试

### 方法1: 独立测试持久化检测器

```bash
cd C:\Users\zzd\Desktop\ganhuo\sysmon
python test_persistence.py
```

这会：
1. 获取初始快照
2. 创建测试持久化项（注册表、计划任务、启动文件夹）
3. 获取最终快照
4. 检测并显示变化
5. 自动清理测试数据
6. 生成JSON报告

### 方法2: 在沙箱中测试

#### 步骤1: 创建测试样本

在你的GUI程序中，或者通过命令行：

```bash
# 创建持久化机制
python test_persistence.py create
```

#### 步骤2: 运行沙箱分析

1. 启动你的 `sysmon_gui_new.py`
2. 进入"🔬 沙箱分析"选项卡
3. 选择 `test_persistence.py` 作为样本
4. 参数填写: `create`
5. 点击"开始沙箱分析"

#### 步骤3: 查看结果

分析完成后，查看生成的HTML报告：
- 会在"🔒 持久化机制"部分显示检测到的变化
- 可疑行为部分也会标记持久化企图

#### 步骤4: 清理测试环境

```bash
python test_persistence.py cleanup
```

---

## 📊 检测示例

### 正常输出示例:

```
[持久化检测] 正在获取初始快照...
[持久化检测] 初始快照已获取
  - 注册表Run键: 15 个
  - 计划任务: 87 个
  - Windows服务: 256 个
  - 启动文件夹项: 3 个
  ...

[样本运行中...]

[持久化检测] 正在获取最终快照...
[持久化检测] 最终快照已获取
[持久化检测] 正在分析变化...
[持久化检测] 检测到 3 个变化

🚨 检测到的持久化变化:

[变化 1]
  类型: Registry Run Key
  操作: Created
  位置: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\TEST_PERSISTENCE_20250118
  值: C:\Windows\System32\notepad.exe
  严重程度: critical
  描述: 新增注册表启动项: TEST_PERSISTENCE_20250118 -> C:\Windows\System32\notepad.exe

[变化 2]
  类型: Scheduled Task
  操作: Created
  位置: TEST_PERSISTENCE_20250118
  值: C:\Windows\System32\notepad.exe
  严重程度: critical
  描述: 新增计划任务: TEST_PERSISTENCE_20250118 -> C:\Windows\System32\notepad.exe

[变化 3]
  类型: Startup Folder
  操作: Created
  位置: C:\Users\zzd\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
  值: TEST_PERSISTENCE_20250118.txt
  严重程度: critical
  描述: 启动文件夹新增文件: TEST_PERSISTENCE_20250118.txt
```

---

## 🔍 集成说明

### 已修改的文件:

1. **新增**: `persistence_detector.py` (完整的持久化检测模块)
2. **修改**: `sandbox_manager.py` (集成持久化检测)
3. **新增**: `test_persistence.py` (测试工具)

### 修改点:

#### sandbox_manager.py

```python
# 1. 导入模块
from persistence_detector import PersistenceDetector

# 2. 初始化
def __init__(self):
    ...
    self.persistence_detector = PersistenceDetector()

# 3. 获取初始快照
def _take_initial_snapshot(self):
    ...
    self.persistence_detector.take_initial_snapshot()

# 4. 检测变化
def stop_analysis(self):
    ...
    self.persistence_detector.take_final_snapshot()
    persistence_changes = self.persistence_detector.detect_changes()

    for change in persistence_changes:
        self.behavior_data['persistence'].append(change)
```

---

## 📝 报告中的显示

在HTML报告中，持久化变化会显示在：

1. **行为统计** - 显示检测到的持久化机制数量
2. **🔒 持久化机制** 专门章节 - 详细列出所有变化
3. **⚠️ 可疑行为** - 每个持久化变化都会标记为可疑行为
4. **风险评分** - 持久化机制会大幅提高风险分数（每个+25分）

---

## ⚙️ 高级配置

### 自定义检测范围

编辑 `persistence_detector.py`，修改 `take_snapshot()` 方法：

```python
def take_snapshot(self):
    snapshot = {
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'registry_run_keys': self._get_registry_run_keys(),  # 启用
        'scheduled_tasks': self._get_scheduled_tasks(),      # 启用
        'services': self._get_services(),                    # 启用
        # 'wmi_subscriptions': self._get_wmi_subscriptions(), # 禁用（太慢）
        # ...
    }
```

### 性能优化

某些检测比较耗时（如WMI订阅、浏览器扩展），如果不需要可以注释掉。

当前配置下，完整快照大约需要 **5-10秒**。

---

## 🐛 故障排除

### 问题1: "获取计划任务超时"

**原因**: 系统计划任务过多
**解决**: 修改 `_get_scheduled_tasks()` 中的 `timeout=30` 参数，增加到60

### 问题2: "权限不足"

**原因**: 某些检测需要管理员权限
**解决**: 使用"以管理员身份启动.bat"运行程序

### 问题3: "检测不到变化"

**原因**: 可能是样本没有创建持久化，或者快照时机不对
**解决**:
- 确保在样本运行前后分别获取快照
- 使用 `test_persistence.py` 验证检测器本身是否正常

### 问题4: "中文乱码"

**原因**: Windows中文系统编码问题
**解决**: 代码中已使用 `encoding='gbk'` 处理，应该正常

---

## 📈 后续增强建议

当前版本是"快照对比"模式，未来可以增强为"实时监控"模式：

1. **注册表监控** - 使用 `RegNotifyChangeKeyValue` API实时监控注册表变化
2. **文件系统监控** - 使用 `ReadDirectoryChangesW` 监控启动文件夹
3. **服务监控** - 通过WMI事件实时监控服务创建
4. **更详细的信息** - 记录创建时间、创建者、完整路径等

---

## ✅ 验收标准

功能正常的话，你应该能看到：

1. ✅ 独立运行 `test_persistence.py` 能检测到3个变化
2. ✅ 在沙箱中分析测试样本能检测到持久化
3. ✅ HTML报告中有"持久化机制"章节
4. ✅ 风险评分会因持久化而提高
5. ✅ 可疑行为列表中包含持久化告警

---

## 🎯 使用建议

1. **分析真实恶意软件时**: 持久化检测是最重要的指标之一
2. **性能考虑**: 初始快照在样本启动前获取，不影响分析
3. **误报处理**: 系统正常更新也可能触发检测，需人工判断
4. **与Procmon配合**: 持久化检测+Procmon日志=完整行为视图

---

## 📞 测试反馈

测试后请告诉我：
- ✅ 功能是否正常？
- ✅ 有没有报错？
- ✅ 检测结果是否准确？
- ✅ 还需要什么增强？

我可以继续优化！
